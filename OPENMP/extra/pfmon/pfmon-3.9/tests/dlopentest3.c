#include <stdio.h>
#include <elf.h>
#include <link.h>
#include <dlfcn.h>
#include <stdlib.h>

int main() {
    void *handle, *handle2;
    double (*dlfunc)(double), (*dlfunc2)(double);
    double retval;
    char *error;    
    int i = 0;
    
    printf("test: pfmon dlopen test 3 started\n");

    handle = dlopen("./libabc.so", RTLD_LAZY);
    if ((error = dlerror()) != NULL)  {
        fprintf (stderr, "%s\n", error);
        exit(-1);
    }                    
    dlfunc = dlsym(handle, "funcX");

    for(i=0; i<256; i++) {
        retval = (*dlfunc)(i);
        if(i % 100 == 0)
            printf("[%d] %lf\n", i, retval);
    }

    dlclose(handle);
    printf("test: closing first library; opening second library\n");
    
    handle2 = dlopen("./libxyz.so", RTLD_LAZY);
    if ((error = dlerror()) != NULL)  {
        fprintf (stderr, "%s\n", error);
        exit(-1);
    }    
    dlfunc2 = dlsym(handle2, "funcX");

    for(i=0; i<256; i++) {
        retval = (*dlfunc2)(i);
        if(i % 100 == 0)
            printf("[%d] %lf\n", i, retval);
    }

    dlclose(handle2);
    
    printf("test: closing both libs; pfmon dlopen test finished\n");
    return 0;
}
