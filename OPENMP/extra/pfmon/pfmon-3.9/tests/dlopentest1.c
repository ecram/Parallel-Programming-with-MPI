#include <stdio.h>
#include <elf.h>
#include <link.h>
#include <dlfcn.h>
#include <stdlib.h>
#include <link.h>

int main(int argc, char **argv) {
    void *handle;
    double (*dlfunc)(double);
    double retval;
    char *error;    
    int i = 0;
    int n;
    
    printf("_r_debug=%p\n", &_r_debug);
    printf("_r_debug.rbrk=0x%lx\n", (unsigned long)_r_debug.r_brk);

    n = argc > 1 ? strtoul(argv[1], NULL, 0) : 1;
    while(n--) {
	    printf("test: pfmon dlopen test 1 started\n");

	    handle = dlopen("./libabc.so", RTLD_LAZY);
	    if ((error = dlerror()) != NULL)  {
		    fprintf (stderr, "%s\n", error);
		    exit(-1);
	    }                    
	    dlfunc = dlsym(handle, "func1");

	    for(i=0; i<256; i++) {
		    retval = (*dlfunc)(i);
		    if(i % 100 == 0)
			    printf("[%d] %lf\n", i, retval);
	    }

	    dlclose(handle);
	    printf("test: closing first library; opening second library\n");

	    handle = dlopen("./libxyz.so", RTLD_LAZY);
	    if ((error = dlerror()) != NULL)  {
		    fprintf (stderr, "%s\n", error);
		    exit(-1);
	    }                    
	    dlfunc = dlsym(handle, "func2");

	    for(i=0; i<256; i++) {
		    retval = (*dlfunc)(i);
		    if(i % 100 == 0)
			    printf("[%d] %lf\n", i, retval);
	    }

	    dlclose(handle);

	    printf("test: closing both libs; pfmon dlopen test finished\n");
    }
    return 0;
}
